# MeshWorks Wiki Ops

Документ для мейнтейнеров и контрибьюторов MeshWorks Wiki. Здесь описаны структура проекта, процессы проверки и выката, а также минимальные требования к контенту. Все инфраструктурные детали (доступы, ip, внутренняя автоматизация) живут в приватных runbook'ах на локальной машине; в публичном репозитории описываем только то, что нужно для работы с репозиторием и GitHub Actions.

## 1. Что важно знать
- Wiki построена на [Docusaurus 3](https://docusaurus.io/) в режиме **docs-only**. Корневой маршрут `/` — это `docs/introduction/index.md`.
- Всё содержимое и конфигурация живут в этом репозитории. Не существует автоматического импорта из Outline или иных CMS.
- Единственный способ выката — GitHub Actions. CI проверяет каждый Pull Request, деплой запускается вручную мейнтейнером.

## 2. Структура
```
repo/
├── docs/                  # Markdown/MDX-контент
├── static/
│   ├── img/logo-*.png
│   └── img/wiki/          # изображения, используемые в статьях
├── src/
│   ├── css/custom.css     # стили и брендирование
│   ├── pages/about.md     # статичные страницы вне docs
│   └── theme/             # переопределения компонентов (Admonition и пр.)
├── docusaurus.config.ts   # глобальные настройки
├── sidebars.ts            # порядок навигации
├── package.json           # скрипты и зависимости
└── docs/wiki/wiki-docusaurus.md (этот файл)
```

## 3. Рабочий процесс
1. Создайте ветку от `main` и выполните `npm ci` один раз.
2. Для правок контента запускайте `npm start` (dev-сервер) или редактируйте через GitHub UI → “Edit this page”.
3. Перед Push/PR обязательно выполняйте `npm run check` (включает `tsc --noEmit` и `docusaurus build`).
4. Убедитесь, что новые изображения лежат в `static/img/wiki/<slug>.png` и ссылка в Markdown ведёт на `/img/wiki/<slug>.png`.
5. Попросите ревьюера из команды; после апрува GitHub Actions автоматически пройдёт CI.

### Требования к front matter
- Обязательные поля: `title`, `slug`, `sidebar_label`, `sidebar_position`.
- Дополнительные поля (`description`, `source_url`, `tags`) используйте по необходимости.
- Избегайте GUID в slug'ах, используйте человекочитаемые пути (`/devices/ready-made/portable`).

### Content style
- Русский язык, нейтральный тон. Указывайте единицы измерения, версии прошивок и даты, если они критичны.
- Для callout'ов используйте стандартные admonitions (`:::tip`, `:::info`, `:::favorite`).
- Код и команды выделяйте бэктиками, многострочные блоки — тройными кавычками с указанием языка (` ```bash `).

## 4. Инструменты и скрипты
- `npm run lint` — быстрая проверка типизации.
- `npm run build` — сборка прод-артефакта (входит в `check`).
- `npm run clear` — очистка `.docusaurus/` при смене конфигурации.
- Для новых страниц удобно добавить шаблон через `npm run swizzle` или скопировать существующий файл.

## 5. CI и деплой
### CI (`.github/workflows/ci.yml`)
- Триггер: `pull_request` и `push` в `main`.
- Шаги: checkout → Node.js 20 → `npm ci` → `npm run check` → загрузка артефакта `build/` (доступен в UI для быстрого превью).

### Deploy (`.github/workflows/deploy.yml`)
- Запускается вручную (`workflow_dispatch`), по умолчанию разворачивает `main`.
- Шаги: checkout → `npm ci` → `npm run check` → rsync исходников на прод → запуск серверного `build_wiki.sh` → рестарт Docusaurus-сервиса → `curl`-smoke тест.
- Все чувствительные данные (SSH хост, пользователь, ключ) хранятся в репозитории как GitHub Secrets (`WIKI_SSH_*`). Личные доступы в этом репо не храним.

## 6. Ревью и чек-лист перед выкатыванием
- [ ] `npm run check` на локальной машине и в CI зелёный.
- [ ] Передаваемые изображения оптимизированы и добавлены в git.
- [ ] В тексте нет ссылок на внутренние инструменты или приватные IP/логины.
- [ ] Обновлены сопутствующие документы (README, CONTRIBUTING) при изменении процесса.
- [ ] Есть заметка о визуальных изменениях в описании PR (скриншот, список страниц).

## 7. Отладка
- CI упал на `tsc`: запустите `npm run lint` локально, поправьте типы/импорты.
- Ошибка `No admonition component found`: пересоберите (`npm run clear && npm run build`) и убедитесь, что `src/theme/Admonition/...` присутствует.
- Если деплой завершился ошибкой rsync/SSH — проверьте GitHub Secrets и права нового пользователя (см. приватный runbook `.codex/docs/wiki-deploy.md`).
- Для визуальных артефактов прогоните `npm run serve` и откройте страницы `/`, `/devices`, `/node-setup`, `/troubleshooting`, `/community`, `/about`.

## 8. FAQ
| Вопрос | Ответ |
|--------|-------|
| Как добавить новую секцию в sidebar? | Правьте `sidebars.ts` и задавайте `sidebar_position` в front matter. |
| Где хранить большие бинарники? | Не коммитим >10 MB. Залейте в CDN/Drive, а в статье оставьте ссылку. |
| Можно ли использовать внешний CSS? | Только через `src/css/custom.css`, соблюдая брендовые цвета. |
| Нужно ли указывать источник? | Да, используйте `source_url` или добавляйте ссылку в тексте. |

## 9. Что в приватных доках
- Доступы, IP, роли и пароли.
- Bitwarden/Status Hub/инфра runbook'и.
- Процедуры восстановления, мониторинг, чек-листы по поддержке. Всё это находится в `.codex/docs` и не публикуется.

Если в публичном репозитории всё ещё встречаются приватные детали — сразу поднимайте issue и удаляйте их в ближайшем коммите.
